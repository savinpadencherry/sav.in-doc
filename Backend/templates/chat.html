<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat - SAV.IN</title>
    
    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Stylesheets -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <!-- Enhanced Navigation with Better Visibility -->
    <nav class="navbar">
        <div class="nav-container">
            <a href="/" class="nav-brand">
                <i class="material-icons">smart_toy</i>
                <span>SAV.IN</span>
            </a>
            
            <div class="nav-links">
                <a href="/upload" class="nav-link">
                    <i class="material-icons">upload_file</i>
                    <span>Upload</span>
                </a>
                <a href="/chat" class="nav-link active">
                    <i class="material-icons">chat</i>
                    <span>Chat</span>
                </a>
            </div>
            
            <div class="nav-user">
                <div class="user-info">
                    <span>Demo User</span>
                    <i class="material-icons">account_circle</i>
                </div>
            </div>
        </div>
    </nav>

    <!-- Fixed Height Chat Interface with Proper Spacing -->
    <div class="chat-layout">
        <!-- Enhanced Chat Sidebar -->
        <div class="chat-sidebar">
            <div class="sidebar-header">
                <h2>
                    <i class="material-icons">chat_bubble</i>
                    Your Chats
                </h2>
                <button class="create-chat-btn" id="createChatBtn">
                    <i class="material-icons">add</i>
                    New Chat
                </button>
            </div>
            
            <div class="chat-list" id="chatList">
                <div class="loading-placeholder">
                    <div class="spinner"></div>
                    <p>Loading chats...</p>
                </div>
            </div>
        </div>

        <!-- Main Chat Area with Visible Headers -->
        <div class="chat-main">
            <div class="chat-header">
                <div class="chat-title-section">
                    <h3 class="current-chat-title" id="currentChatTitle">Select or Create a Chat</h3>
                    <div class="current-chat-meta" id="currentChatMeta">
                        <span>Choose a chat or create a new one to get started</span>
                    </div>
                    <div class="selected-documents" id="selectedDocuments">
                        <!-- Selected documents will appear here -->
                    </div>
                </div>
            </div>

            <div class="messages-container" id="messagesContainer">
                <div class="chat-placeholder">
                    <i class="material-icons">smart_toy</i>
                    <h3>Welcome to SAV.IN!</h3>
                    <p>Create a new chat or select an existing one to start conversing with your documents using our local Granite AI models.</p>
                </div>
            </div>

            <div class="chat-input-container">
                <div class="input-wrapper">
                    <textarea 
                        class="message-input" 
                        id="messageInput" 
                        placeholder="Create or select a chat first..."
                        rows="1"
                        disabled
                    ></textarea>
                    <button class="send-btn" id="sendBtn" disabled>
                        <i class="material-icons">send</i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Enhanced Document Preview Panel -->
        <div class="pdf-viewer">
            <div class="viewer-header">
                <h3>
                    <i class="material-icons">preview</i>
                    Document Preview
                </h3>
                <div class="viewer-controls">
                    <button class="control-btn" title="Zoom Out">
                        <i class="material-icons">zoom_out</i>
                    </button>
                    <button class="control-btn" title="Zoom In">
                        <i class="material-icons">zoom_in</i>
                    </button>
                    <button class="control-btn" title="Fullscreen">
                        <i class="material-icons">fullscreen</i>
                    </button>
                </div>
            </div>
            
            <div class="pdf-content" id="pdfPreview">
                <div class="empty-state">
                    <i class="material-icons">description</i>
                    <h4>Document Preview</h4>
                    <p>Select documents and start chatting to see AI-highlighted sources appear here</p>
                    <small>The AI will automatically highlight relevant sections as you ask questions</small>
                </div>
            </div>
            
            <div class="document-selection-area" style="max-height: 300px; overflow-y: auto; padding: 16px; border-top: 2px solid var(--divider);">
                <h4 style="margin-bottom: 16px; color: var(--text-primary); font-size: 16px;">
                    <i class="material-icons" style="vertical-align: middle; margin-right: 8px;">library_books</i>
                    Select Documents
                </h4>
                <div class="document-list" id="documentList">
                    <div class="loading-placeholder">
                        <div class="spinner"></div>
                        <p>Loading documents...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Enhanced Create Chat Modal -->
    <div class="modal-overlay" id="modalOverlay" style="display: none;">
        <div class="modal" id="chatModal">
            <div class="modal-header">
                <h3>Create New Chat Session</h3>
                <p>Give your chat a memorable name to organize your conversations</p>
            </div>
            <div class="modal-body">
                <input 
                    type="text" 
                    class="modal-input" 
                    id="chatNameInput" 
                    placeholder="Enter chat name (e.g., Research Discussion)..."
                    maxlength="100"
                >
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="chatManager.hideModal()">
                    <i class="material-icons">close</i>
                    Cancel
                </button>
                <button class="btn btn-primary" id="createChatConfirmBtn">
                    <i class="material-icons">add</i>
                    Create Chat
                </button>
            </div>
        </div>
    </div>

    <!-- Global Scripts -->
    <script>
        // Enhanced global configuration and API helper
        const API_BASE = '/api';
        
        async function apiRequest(endpoint, options = {}) {
            const url = `${API_BASE}${endpoint}`;
            const defaultOptions = {
                headers: {
                    'Content-Type': 'application/json',
                },
                ...options
            };
            
            if (options.body && options.body instanceof FormData) {
                delete defaultOptions.headers['Content-Type'];
            }
            
            try {
                const response = await fetch(url, defaultOptions);
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.message || `HTTP ${response.status}`);
                }
                
                return data;
            } catch (error) {
                console.error('API Request Error:', error);
                throw error;
            }
        }
        
        // Enhanced notification system
        function showNotification(message, type = 'info', duration = 4000) {
            const existing = document.querySelectorAll('.notification');
            existing.forEach(notification => notification.remove());
            
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            
            const icon = type === 'success' ? 'check_circle' : 
                        type === 'error' ? 'error' : 
                        type === 'warning' ? 'warning' : 'info';
            
            notification.innerHTML = `
                <i class="material-icons">${icon}</i>
                <span>${message}</span>
            `;
            
            notification.style.cssText = `
                position: fixed;
                top: 100px;
                right: 30px;
                padding: 16px 24px;
                border-radius: 12px;
                display: flex;
                align-items: center;
                gap: 12px;
                z-index: 10001;
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
                color: white;
                font-weight: 600;
                min-width: 320px;
                backdrop-filter: blur(15px);
                animation: slideInRight 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
                border: 1px solid rgba(255, 255, 255, 0.2);
            `;
            
            const backgrounds = {
                success: 'linear-gradient(135deg, #4caf50, #81c784)',
                error: 'linear-gradient(135deg, #f44336, #e57373)', 
                warning: 'linear-gradient(135deg, #ff9800, #ffb74d)',
                info: 'linear-gradient(135deg, #2196f3, #64b5f6)'
            };
            
            notification.style.background = backgrounds[type];
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.style.animation = 'slideOutRight 0.3s ease-in';
                    setTimeout(() => notification.remove(), 300);
                }
            }, duration);
        }
        
        // Add slideIn/Out animations
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideInRight {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOutRight {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
        `;
        document.head.appendChild(style);
    </script>
    
    <!-- Enhanced Chat Script -->
    <script src="{{ url_for('static', filename='js/chat.js') }}"></script>
</body>
</html>
